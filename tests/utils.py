"""
Utility functions for tests.
Regenerate the comparison files only when changing the precision of the models.
"""
import os

import matplotlib.pyplot as plt
import numpy as np

from .context import petitRADTRANS

version = "2.3.2"  # petitRADTRANS.version.version

tests_data_directory = os.path.join(os.path.dirname(__file__), 'data')
reference_filenames = {
    'guillot_2010': 'radtrans_guillot_2010_temperature_profile_ref',
    'correlated_k_transmission': 'radtrans_correlated_k_transmission_ref',
    'correlated_k_emission': 'radtrans_correlated_k_emission_ref',
    'line_by_line_transmission': 'radtrans_line_by_line_transmission_ref',
    'line_by_line_emission': 'radtrans_line_by_line_emission_ref'
}

# Complete filenames
reference_filenames = {
    key: os.path.join(tests_data_directory, value + '.npz') for key, value in reference_filenames.items()
}


# Common parameters
def init_radtrans_parameters():
    """
    Initialize various parameters used both to perform the tests and generate the reference files.
    Do not change these parameters when comparing with a previous version.
    """
    _pressures = np.logspace(-6, 2, 27)  # pressure array used for all tests

    # Temperature and mass fractions
    _mass_fractions = {
        'H2': 0.74 * np.ones_like(_pressures),
        'He': 0.24 * np.ones_like(_pressures),
        'H2O_HITEMP': 0.001 * np.ones_like(_pressures),
        'H2O_main_iso': 0.001 * np.ones_like(_pressures),
        'CO_all_iso_HITEMP': 0.1 * np.ones_like(_pressures),
        'CO_all_iso': 0.1 * np.ones_like(_pressures),
    }

    _mean_molar_mass = 2.33 * np.ones_like(_pressures)  # (g.cm-3)

    _temperature_iso = 1200  # (K)
    _temperature_guillot_2010_parameters = {
        'kappa_ir': 0.01,
        'gamma': 0.4,
        'intrinsic_temperature': 200,  # (K)
        'equilibrium_temperature': 1500  # (K)
    }

    # Planetary parameters
    _planetary_parameters = {
        'reference_pressure': 0.01,  # (bar)
        'radius': 1.838,  # (R_jup)
        'surface_gravity': 1e1 ** 2.45,  # (cm.s-2)
    }

    # Spectrum parameters
    _spectrum_parameters = {
        'line_species_correlated_k': [
            'H2O_HITEMP',
            'CO_all_iso_HITEMP'
        ],
        'line_species_line_by_line': [
            'H2O_main_iso',
            'CO_all_iso'
        ],
        'rayleigh_species': ['H2', 'He'],
        'continuum_opacities': ['H2-H2', 'H2-He'],
        'wavelength_range_correlated_k': [4.3, 5.0],
        'wavelength_range_line_by_line': [2.3000, 2.3025],
    }

    return _pressures, _mass_fractions, _mean_molar_mass, _temperature_iso, _temperature_guillot_2010_parameters, \
        _planetary_parameters, _spectrum_parameters


pressures, mass_fractions, mean_molar_mass, temperature_isothermal, temperature_guillot_2010_parameters, \
    planetary_parameters, spectrum_parameters = init_radtrans_parameters()


# Data files generation functions
def create_guillot_2010_temperature_profile_ref(plot_figure=False):
    temperature_guillot = petitRADTRANS.nat_cst.guillot_global(
        pressure=pressures,
        kappa_ir=temperature_guillot_2010_parameters['kappa_ir'],
        gamma=temperature_guillot_2010_parameters['gamma'],
        grav=planetary_parameters['surface_gravity'],
        t_int=temperature_guillot_2010_parameters['intrinsic_temperature'],
        t_equ=temperature_guillot_2010_parameters['equilibrium_temperature']
    )

    np.savez_compressed(
        os.path.join(reference_filenames['guillot_2010']),
        temperature=np.asarray(temperature_guillot),
        pressure=np.asarray(pressures),
        header=f'File generated by tests.utils.create_guillot_2010_temperature_profile_ref\n'
               f'temperature units: K\n'
               f'pressure units: bar',
        prt_version=f'{version}'
    )

    if plot_figure:
        plt.figure()
        plt.semilogy(temperature_guillot, pressures)
        plt.ylim([1e2, 1e-6])
        plt.xlabel('Temperature (K)')
        plt.ylabel('Pressure (bar)')
        plt.title('Guillot 2010 temperature profile')


def create_radtrans_correlated_k_emission_spectrum_ref(plot_figure=False):
    from .test_radtrans import atmosphere_ck, temperature_guillot_2010

    atmosphere_ck.calc_flux(
        temp=temperature_guillot_2010,
        abunds=mass_fractions,
        gravity=planetary_parameters['surface_gravity'],
        mmw=mean_molar_mass,
    )

    wavelength = np.asarray(petitRADTRANS.nat_cst.c / atmosphere_ck.freq * 1e4)

    np.savez_compressed(
        os.path.join(reference_filenames['correlated_k_emission']),
        wavelength=wavelength,
        spectral_radiosity=np.asarray(atmosphere_ck.flux),
        header=f'File generated by tests.utils.create_radtrans_correlated_k_emission_spectrum_ref\n'
               f'wavelength units: um\n'
               f'spectral radiosity units: erg.cm-2.s-1.Hz-1',
        prt_version=f'{version}'
    )

    if plot_figure:
        plt.figure()
        plt.semilogx(wavelength, atmosphere_ck.flux)
        plt.xlabel(r'Wavelength ($\mu$m)')
        plt.ylabel(r'Spectral radiosity (erg$\cdot$s$^{-1}\cdot$cm$^{-2}\cdot$Hz$^{-1}$)')
        plt.title('Correlated-k emission spectrum')


def create_radtrans_correlated_k_transmission_spectrum_ref(plot_figure=False):
    from .test_radtrans import atmosphere_ck

    atmosphere_ck.calc_transm(
        temp=temperature_isothermal * np.ones_like(pressures),
        abunds=mass_fractions,
        gravity=planetary_parameters['surface_gravity'],
        mmw=mean_molar_mass,
        R_pl=planetary_parameters['radius'] * petitRADTRANS.nat_cst.r_jup_mean,
        P0_bar=planetary_parameters['reference_pressure']
    )

    wavelength = np.asarray(petitRADTRANS.nat_cst.c / atmosphere_ck.freq * 1e4)
    transit_radius = np.asarray(atmosphere_ck.transm_rad / petitRADTRANS.nat_cst.r_jup_mean)

    np.savez_compressed(
        os.path.join(reference_filenames['correlated_k_transmission']),
        wavelength=wavelength,
        transit_radius=transit_radius,
        header=f'File generated by tests.utils.create_radtrans_correlated_k_transmission_spectrum_ref\n'
               f'wavelength units: um\n'
               f'transit_radius units: R_jup',
        prt_version=f'{version}'
    )

    if plot_figure:
        plt.figure()
        plt.semilogx(wavelength, transit_radius)
        plt.xlabel(r'Wavelength ($\mu$m)')
        plt.ylabel(r'Transit radius (R$_{\rm{Jup}}$)')
        plt.title('Correlated-k transmission spectrum')


def create_radtrans_line_by_line_emission_spectrum_ref(plot_figure=False):
    from .test_radtrans import atmosphere_lbl, temperature_guillot_2010

    atmosphere_lbl.calc_flux(
        temp=temperature_guillot_2010,
        abunds=mass_fractions,
        gravity=planetary_parameters['surface_gravity'],
        mmw=mean_molar_mass,
    )

    wavelength = np.asarray(petitRADTRANS.nat_cst.c / atmosphere_lbl.freq * 1e4)

    np.savez_compressed(
        os.path.join(reference_filenames['line_by_line_emission']),
        wavelength=wavelength,
        spectral_radiosity=np.asarray(atmosphere_lbl.flux),
        header=f'File generated by tests.utils.create_radtrans_line_by_line_emission_spectrum_ref\n'
               f'wavelength units: um\n'
               f'spectral radiosity units: erg.cm-2.s-1.Hz-1',
        prt_version=f'{version}'
    )

    if plot_figure:
        plt.figure()
        plt.semilogx(wavelength, atmosphere_lbl.flux)
        plt.xlabel(r'Wavelength ($\mu$m)')
        plt.ylabel(r'Spectral radiosity (erg$\cdot$s$^{-1}\cdot$cm$^{-2}\cdot$Hz$^{-1}$)')
        plt.title('Line-by-line emission spectrum')


def create_radtrans_line_by_line_transmission_spectrum_ref(plot_figure=False):
    from .test_radtrans import atmosphere_lbl

    atmosphere_lbl.calc_transm(
        temp=temperature_isothermal * np.ones_like(pressures),
        abunds=mass_fractions,
        gravity=planetary_parameters['surface_gravity'],
        mmw=mean_molar_mass,
        R_pl=planetary_parameters['radius'] * petitRADTRANS.nat_cst.r_jup_mean,
        P0_bar=planetary_parameters['reference_pressure']
    )

    wavelength = np.asarray(petitRADTRANS.nat_cst.c / atmosphere_lbl.freq * 1e4)
    transit_radius = np.asarray(atmosphere_lbl.transm_rad / petitRADTRANS.nat_cst.r_jup_mean)

    np.savez_compressed(
        os.path.join(reference_filenames['line_by_line_transmission']),
        wavelength=wavelength,
        transit_radius=transit_radius,
        header=f'File generated by tests.utils.create_radtrans_line_by_line_transmission_spectrum_ref\n'
               f'wavelength units: um\n'
               f'transit_radius units: R_jup',
        prt_version=f'{version}'
    )

    if plot_figure:
        plt.figure()
        plt.semilogx(wavelength, transit_radius)
        plt.xlabel(r'Wavelength ($\mu$m)')
        plt.ylabel(r'Transit radius (R$_{\rm{Jup}}$)')
        plt.title('Line-by-line transmission spectrum')


def create_all_comparison_files(plot_figure=False):
    create_guillot_2010_temperature_profile_ref(plot_figure)
    create_radtrans_correlated_k_emission_spectrum_ref(plot_figure)
    create_radtrans_correlated_k_transmission_spectrum_ref(plot_figure)
    create_radtrans_line_by_line_emission_spectrum_ref(plot_figure)
    create_radtrans_line_by_line_transmission_spectrum_ref(plot_figure)
