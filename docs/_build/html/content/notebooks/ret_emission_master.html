

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Emission spectrum retrieval: main script &mdash; petitRADTRANS 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Master retrieval model: emission case" href="ret_emission_retrieval_model.html" />
    <link rel="prev" title="Emission spectrum retrieval" href="../ret_emission.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> petitRADTRANS
          

          
            
            <img src="../../_static/petitlogo.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Guide:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../available_opacities.html">Available opacity species</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../retrieval_examples.html">Retrieval Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../ret_transmission.html">Transmission spectrum retrieval</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../ret_emission.html">Emission spectrum retrieval</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Emission spectrum retrieval: main script</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#General-setup">General setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Reading-the-observational-data-in">Reading the observational data in</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Creating-the-radiative-transfer-object">Creating the radiative transfer object</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Prior-setup-for-retrieval">Prior setup for retrieval</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Define-the-log-probability-function">Define the log-probability function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Run-the-MCMC:-pre-burn">Run the MCMC: pre-burn</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Run-the-main-MCMC-chain">Run the main MCMC chain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Save-the-results">Save the results</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="ret_emission_retrieval_model.html">Master retrieval model: emission case</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ret_analysis.html">Analysis of results</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../opa_add.html">Adding opacities</a></li>
</ul>
<p class="caption"><span class="caption-text">Code documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code.html">Code documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">petitRADTRANS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../retrieval_examples.html">Retrieval Examples</a> &raquo;</li>
        
          <li><a href="../ret_emission.html">Emission spectrum retrieval</a> &raquo;</li>
        
      <li>Emission spectrum retrieval: main script</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/content/notebooks/ret_emission_master.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Emission-spectrum-retrieval:-main-script">
<h1>Emission spectrum retrieval: main script<a class="headerlink" href="#Emission-spectrum-retrieval:-main-script" title="Permalink to this headline">¶</a></h1>
<p>This section shows the main script of the implementation of the emission spectrum retrieval. The source <code class="docutils literal notranslate"><span class="pre">retrieve_emission_paper.py</span></code> can be found in the <code class="docutils literal notranslate"><span class="pre">petitRADTRANS</span></code> source folder, in the sub folder <code class="docutils literal notranslate"><span class="pre">retrieval_examples/emission</span></code>. This is the implementation used for the emission retrieval case of the <a class="reference external" href="https://arxiv.org/abs/1904.11504">petitRADTRANS paper</a>. In this retrieval we make use of the <a class="reference external" href="https://emcee.readthedocs.io">emcee</a> package, see <a class="reference external" href="https://arxiv.org/abs/1202.3665">Foreman-Mackey et al.
(2012)</a>.</p>
<div class="section" id="General-setup">
<h2>General setup<a class="headerlink" href="#General-setup" title="Permalink to this headline">¶</a></h2>
<p>First we load all outside packages:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>import numpy as np
import sys
import emcee
import pickle as pickle
import time
from emcee.utils import MPIPool
from scipy.interpolate import interp1d
</pre></div>
</div>
</div>
<p>Importing <code class="docutils literal notranslate"><span class="pre">MPIPool</span></code> allows to use <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> on the cluster for parallelization. In practise we always used multiprocessing, however, also on the cluster (see below).</p>
<p>Next we load petitRADTRANS and other packages written for this retrieval setup:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from petitRADTRANS import Radtrans
import master_retrieval_model as rm
from petitRADTRANS import nat_cst as nc
import rebin_give_width as rgw
</pre></div>
</div>
</div>
<p>The package <code class="docutils literal notranslate"><span class="pre">master_retrieval_model.py</span></code> contains the function that returns the model spectrum, given the input parameters. It can be found in <code class="docutils literal notranslate"><span class="pre">retrieval_examples/emission</span></code> as well, and is explained <a class="reference external" href="ret_emission_retrieval_model.html">here</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rebin_give_width.so</span></code> package is a Fortran binary compiled for use in Python, written specifically for this retrieval example. It is written in Fortran to increase speed. It rebins the forward model to the observational wavelength grid, with the width of the wavelength bin given for every grid point. It is compiled by typing:</p>
<p><code class="docutils literal notranslate"><span class="pre">f2py</span> <span class="pre">-c</span> <span class="pre">--opt='-O3</span> <span class="pre">-funroll-loops</span> <span class="pre">-ftree-vectorize</span> <span class="pre">-ftree-loop-optimize</span> <span class="pre">-msse</span> <span class="pre">-msse2</span> <span class="pre">-m3dnow'</span> <span class="pre">-m</span> <span class="pre">rebin_give_width</span> <span class="pre">rebin_give_width.f90</span></code></p>
<p>If it won’t run, also see the general installation tips of petitRADTRANS, when building <code class="docutils literal notranslate"><span class="pre">.so</span></code> files, <a class="reference external" href="../installation.html">here</a>.</p>
<p>Next we specify the observation paths:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>retrieval_name = &#39;JWST_emission_petitRADTRANSpaper&#39;
absolute_path = &#39;&#39; # end with forward slash!
observation_files = {}
observation_files[&#39;NIRISS SOSS&#39;] = &#39;NIRISS_SOSS_flux.dat&#39;
observation_files[&#39;NIRSpec G395M&#39;] = &#39;NIRSpec_G395M_flux.dat&#39;
observation_files[&#39;MIRI LRS&#39;] = &#39;MIRI_LRS_flux.dat&#39;
</pre></div>
</div>
</div>
<p>If you want to plot the spectra for testing purposes (i.e.&nbsp;when running locally on your machine, on a single core), set <code class="docutils literal notranslate"><span class="pre">plotting</span> <span class="pre">=</span> <span class="pre">True</span></code>. Don’t do this when you run the actual retrieval:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># For testing purposes only
plotting = False
if plotting:
    import pylab as plt
</pre></div>
</div>
</div>
<p>Next we setup the hyperparameters of the emcee MCMC sampler:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Retrieval hyperparameters
stepsize = 1.75
n_walkers = 240
n_iter = 5000
</pre></div>
</div>
</div>
<p>The 240 walkers will carry out 4200 steps, that is we will draw 1,200,000 samples.</p>
<p>Put <code class="docutils literal notranslate"><span class="pre">cluster</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> if you want to run with <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> on the cluster. We only used multiprocessing in our cases, that is leaving <code class="docutils literal notranslate"><span class="pre">cluster</span> <span class="pre">=</span> <span class="pre">False</span></code> and setting <code class="docutils literal notranslate"><span class="pre">n_threads</span> <span class="pre">=</span> <span class="pre">40</span></code> when running on, for example, 40 cores.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>cluster = False       # Submit to cluster
n_threads = 1         # Use mutliprocessing (local = 1)
write_threshold = 200 # number of iterations after which diagnostics are updated
</pre></div>
</div>
</div>
<p>Next we specify the wavelength range of the models (a bit larger than that of the observations), and fixed parameters that will not be retrieved for the transmission spectrum case. Don’t make the wavelength range larger than needed, it will decrease the forward modeling speed. We also get the stellar spectrum, to be used for the calculation of <span class="math notranslate nohighlight">\(F_{\rm Pl}/F_*\)</span> later.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Wavelength range of observations, fixed parameters that will not be retrieved
WLEN = [0.8, 14.0]
LOG_G =  2.58
R_pl =   1.84*nc.r_jup_mean
R_star = 1.81*nc.r_sun
# Get host star spectrum to calculate F_pl / F_star later.
T_star = 6295.
x = nc.get_PHOENIX_spec(T_star)
fstar = interp1d(x[:,0], x[:,1])
</pre></div>
</div>
</div>
</div>
<div class="section" id="Reading-the-observational-data-in">
<h2>Reading the observational data in<a class="headerlink" href="#Reading-the-observational-data-in" title="Permalink to this headline">¶</a></h2>
<p>See the headers of the data files for the units. We read in the wavelength, the relative flux decrease <span class="math notranslate nohighlight">\((R_{\rm planet}/R_*)^2\)</span>, and its error.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>data_wlen = {}
data_flux_nu = {}
data_flux_nu_error = {}
data_wlen_bins = {}

for name in observation_files.keys():

    dat_obs = np.genfromtxt(observation_files[name])
    data_wlen[name] = dat_obs[:,0]*1e-4
    data_flux_nu[name] = dat_obs[:,1]
    data_flux_nu_error[name] = dat_obs[:,2]

    data_wlen_bins[name] = np.zeros_like(data_wlen[name])
    data_wlen_bins[name][:-1] = np.diff(data_wlen[name])
    data_wlen_bins[name][-1] = data_wlen_bins[name][-2]
</pre></div>
</div>
</div>
</div>
<div class="section" id="Creating-the-radiative-transfer-object">
<h2>Creating the radiative transfer object<a class="headerlink" href="#Creating-the-radiative-transfer-object" title="Permalink to this headline">¶</a></h2>
<p>This object will later be used by the <code class="docutils literal notranslate"><span class="pre">master_retrieval_model.py</span></code> package.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>### Create and setup radiative transfer object
# Create random P-T profile to create RT arrays of the Radtrans object.
temp_params = {}
temp_params[&#39;log_delta&#39;] = -6.
temp_params[&#39;log_gamma&#39;] = np.log10(0.4)
temp_params[&#39;t_int&#39;] = 750.
temp_params[&#39;t_equ&#39;] = 0.
temp_params[&#39;log_p_trans&#39;] = -3.
temp_params[&#39;alpha&#39;] = 0.
p, t = nc.make_press_temp(temp_params)

# Create the Ratrans object here
rt_object = Radtrans(line_species=[&#39;H2&#39;, &#39;CO_all_iso&#39;, &#39;H2O&#39;, \
                                  &#39;CH4&#39;, &#39;NH3&#39;, &#39;CO2&#39;, &#39;H2S&#39;, \
                                  &#39;Na&#39;, &#39;K&#39;], \
                    rayleigh_species=[&#39;H2&#39;,&#39;He&#39;], \
                    continuum_opacities = [&#39;H2-H2&#39;,&#39;H2-He&#39;], \
                    mode=&#39;c-k&#39;, \
                    wlen_bords_micron=WLEN)

# Create the RT arrays of appropriate lengths
rt_object.setup_opa_structure(p)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Read CIA opacities for H2-H2...
  Read CIA opacities for H2-He...
 Done.

</pre></div></div>
</div>
</div>
<div class="section" id="Prior-setup-for-retrieval">
<h2>Prior setup for retrieval<a class="headerlink" href="#Prior-setup-for-retrieval" title="Permalink to this headline">¶</a></h2>
<p>Here we set up the priors for the temperature profile parameters, abundances, and other free parameters, as described in the petitRADTRANS paper.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>def b_range(x, b):
    if x &gt; b:
        return -np.inf
    else:
        return 0.

def a_b_range(x, a, b):
    if x &lt; a:
        return -np.inf
    elif x &gt; b:
        return -np.inf
    else:
        return 0.

log_priors = {}
log_priors[&#39;log_delta&#39;]      = lambda x: -((x-(-5.5))/2.5)**2./2.
log_priors[&#39;log_gamma&#39;]      = lambda x: -((x-(-0.0))/2.)**2./2.
log_priors[&#39;t_int&#39;]          = lambda x: a_b_range(x, 0., 1500.)
log_priors[&#39;t_equ&#39;]          = lambda x: a_b_range(x, 0., 4000.)
log_priors[&#39;log_p_trans&#39;]    = lambda x: -((x-(-3))/3.)**2./2.
log_priors[&#39;alpha&#39;]          = lambda x: -((x-0.25)/0.4)**2./2.
log_priors[&#39;log_g&#39;]          = lambda x: a_b_range(x, 2.0, 3.7)
log_priors[&#39;log_P0&#39;]         = lambda x: a_b_range(x, -4, 2.)

# Priors for log mass fractions
log_priors[&#39;CO_all_iso&#39;]     = lambda x: a_b_range(x, -10., 0.)
log_priors[&#39;H2O&#39;]            = lambda x: a_b_range(x, -10., 0.)
log_priors[&#39;CH4&#39;]            = lambda x: a_b_range(x, -10., 0.)
log_priors[&#39;NH3&#39;]            = lambda x: a_b_range(x, -10., 0.)
log_priors[&#39;CO2&#39;]            = lambda x: a_b_range(x, -10., 0.)
log_priors[&#39;H2S&#39;]            = lambda x: a_b_range(x, -10., 0.)
log_priors[&#39;Na&#39;]             = lambda x: a_b_range(x, -10., 0.)
log_priors[&#39;K&#39;]              = lambda x: a_b_range(x, -10., 0.)
</pre></div>
</div>
</div>
</div>
<div class="section" id="Define-the-log-probability-function">
<h2>Define the log-probability function<a class="headerlink" href="#Define-the-log-probability-function" title="Permalink to this headline">¶</a></h2>
<p>First we set up the variables that will be changed and be written into the diagnostice file, during the retrieval run:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Declare diagnostics
function_calls = 0
computed_spectra = 0
NaN_spectra = 0
delta_wt = write_threshold

start_time = time.time()
file_object = open(absolute_path + &#39;diag_&#39; + \
                       retrieval_name + &#39;.dat&#39;, &#39;w&#39;).close()
</pre></div>
</div>
</div>
<p>Here it comes…. the log-probability function! I tried to comment it sufficiently, shoot me an email if something is unclear.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>def calc_log_prob(params):

    log_delta, log_gamma, t_int, t_equ, log_p_trans, alpha, \
      log_g, log_P0 = params[:-8]

    # Make dictionary for modified Guillot parameters
    temp_params = {}
    temp_params[&#39;log_delta&#39;] = log_delta
    temp_params[&#39;log_gamma&#39;] = log_gamma
    temp_params[&#39;t_int&#39;] = t_int
    temp_params[&#39;t_equ&#39;] = t_equ
    temp_params[&#39;log_p_trans&#39;] = log_p_trans
    temp_params[&#39;alpha&#39;] = alpha

    # Make dictionary for log &#39;metal&#39; abundances
    ab_metals = {}
    ab_metals[&#39;CO_all_iso&#39;]     = params[-8:][0]
    ab_metals[&#39;H2O&#39;]            = params[-8:][1]
    ab_metals[&#39;CH4&#39;]            = params[-8:][2]
    ab_metals[&#39;NH3&#39;]            = params[-8:][3]
    ab_metals[&#39;CO2&#39;]            = params[-8:][4]
    ab_metals[&#39;H2S&#39;]            = params[-8:][5]
    ab_metals[&#39;Na&#39;]             = params[-8:][6]
    ab_metals[&#39;K&#39;]              = params[-8:][7]

    global function_calls
    global computed_spectra
    global NaN_spectra
    global write_threshold

    function_calls += 1

    # Prior calculation of all input parameters
    log_prior = 0.

    # Alpha should not be smaller than -1, this
    # would lead to negative temperatures!
    if alpha &lt; -1:
        return -np.inf

    for key in temp_params.keys():
        log_prior += log_priors[key](temp_params[key])

    log_prior += log_priors[&#39;log_g&#39;](log_g)
    log_prior += log_priors[&#39;log_P0&#39;](log_P0)

    # Metal abundances: check that their
    # summed mass fraction is below 1.
    metal_sum = 0.
    for name in ab_metals.keys():
        log_prior += log_priors[name](ab_metals[name])
        metal_sum += 1e1**ab_metals[name]

    if metal_sum &gt; 1.:
        log_prior += -np.inf

    # Return -inf if parameters fall outside prior distribution
    if (log_prior == -np.inf):
        return -np.inf

    # Calculate the log-likelihood
    log_likelihood = 0.

    # Calculate the forward model, this
    # returns the wavelengths in cm and the flux F_nu
    # in erg/cm^2/s/Hz
    wlen, flux_nu = \
            rm.retrieval_model_plain(rt_object, temp_params, log_g, \
                                         log_P0, R_pl, ab_metals)

    # Just to make sure that a long chain does not die
    # unexpectedly:
    # Return -inf if forward model returns NaN values
    if np.sum(np.isnan(flux_nu)) &gt; 0:
        print(&quot;NaN spectrum encountered&quot;)
        NaN_spectra += 1
        return -np.inf

    # Convert to observation for emission case
    flux_star = fstar(wlen)
    flux_sq   = flux_nu/flux_star*(R_pl/R_star)**2

    # Calculate log-likelihood
    for instrument in data_wlen.keys():

        # Rebin model to observation
        flux_rebinned = rgw.rebin_give_width(wlen, flux_sq, \
                        data_wlen[instrument], data_wlen_bins[instrument])

        if plotting:
            plt.errorbar(data_wlen[instrument], \
                             data_flux_nu[instrument], \
                             data_flux_nu_error[instrument], \
                             fmt = &#39;o&#39;, \
                             zorder = -20, \
                             color = &#39;red&#39;)

            plt.plot(data_wlen[instrument], \
                             flux_rebinned, \
                             &#39;s&#39;, \
                             zorder = -20, \
                             color = &#39;blue&#39;)

        # Calculate log-likelihood
        log_likelihood += -np.sum(((flux_rebinned - data_flux_nu[instrument])/ \
                           data_flux_nu_error[instrument])**2.)/2.

    if plotting:
        plt.plot(wlen, flux_sq, color = &#39;black&#39;)
        plt.xscale(&#39;log&#39;)
        plt.show()

    computed_spectra += 1

    if (function_calls &gt;= write_threshold):

        write_threshold += delta_wt
        hours = (time.time() - start_time)/3600.0
        info_list = [function_calls, computed_spectra, NaN_spectra, \
                 log_prior + log_likelihood, hours]

        file_object = open(absolute_path + &#39;diag_&#39; + retrieval_name + &#39;.dat&#39;, &#39;a&#39;)

        for i in np.arange(len(info_list)):
            if (i == len(info_list) - 1):
                file_object.write(str(info_list[i]).ljust(15) + &quot;\n&quot;)
            else:
                file_object.write(str(info_list[i]).ljust(15) + &quot; &quot;)
        file_object.close()

    print(log_prior + log_likelihood)
    print(&quot;--&gt; &quot;, function_calls, &quot; --&gt; &quot;, computed_spectra)
    if np.isnan(log_prior + log_likelihood):
        return -np.inf
    else:
        return log_prior + log_likelihood

def lnprob(x):
    return calc_log_prob(x)
</pre></div>
</div>
</div>
</div>
<div class="section" id="Run-the-MCMC:-pre-burn">
<h2>Run the MCMC: pre-burn<a class="headerlink" href="#Run-the-MCMC:-pre-burn" title="Permalink to this headline">¶</a></h2>
<p>Here we first run a so-called pre-burn, to find the parameter region to zero-in on.</p>
<p>Emcee needs to know the number of parameters:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>n_dim = len(log_priors)
</pre></div>
</div>
</div>
<p>Next we set up the initial walker positions, note that we set log_P0 to a constant value (-2), as this is not relevant for calculating emission spectra:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Set initial position vectors in parameter space
p0 = [np.array([np.random.normal(loc = -5.5, scale = 2.5, size=1)[0], \
                np.random.normal(loc = 0., scale = 2., size=1)[0], \
                0.+1500.*np.random.uniform(size=1)[0], \
                0.+4000.*np.random.uniform(size=1)[0], \
                np.random.normal(loc = -3., scale = 3., size=1)[0], \
                np.random.normal(loc = -0.25, scale = 0.4, size=1)[0], \
                LOG_G,
                -2., \
                -10.+10.*np.random.uniform(size=1)[0], \
                -10.+10.*np.random.uniform(size=1)[0], \
                -10.+10.*np.random.uniform(size=1)[0], \
                -10.+10.*np.random.uniform(size=1)[0], \
                -10.+10.*np.random.uniform(size=1)[0], \
                -10.+10.*np.random.uniform(size=1)[0], \
                -10.+10.*np.random.uniform(size=1)[0], \
                -10.+10.*np.random.uniform(size=1)[0]] \
                ) for i in range(n_walkers)]
</pre></div>
</div>
</div>
<p>Now we run the pre-burn MCMC chain, depending on where and how we want to run it (on the cluster using mpirun, on the cluster (or locally) using multiple cores, or just on a single core):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>if cluster:
    pool = MPIPool()
    if not pool.is_master():
        pool.wait()
        sys.exit(0)
    sampler = emcee.EnsembleSampler(n_walkers, n_dim, lnprob, \
                                        a = stepsize, pool = pool)
else:
    if n_threads &gt; 1:
        sampler = emcee.EnsembleSampler(n_walkers, n_dim, lnprob, \
                                            a = stepsize, threads = n_threads)
    else:
        sampler = emcee.EnsembleSampler(n_walkers, n_dim, lnprob, \
                                            a = stepsize)

pre_burn_in_runs = int(np.min([399, n_iter/10])) + 3
pos, prob, state = sampler.run_mcmc(p0, pre_burn_in_runs)
</pre></div>
</div>
</div>
<p>As we have 240 walkers, the value of <code class="docutils literal notranslate"><span class="pre">pre_burn_in_runs</span></code> ensure that we draw at least ~100,000 samples during the pre-burn.</p>
</div>
<div class="section" id="Run-the-main-MCMC-chain">
<h2>Run the main MCMC chain<a class="headerlink" href="#Run-the-main-MCMC-chain" title="Permalink to this headline">¶</a></h2>
<p>Now we get the best-fit position of the pre-burn, and restart the actual retrieval in a so-called “Gauss ball” around the best-fit position:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Get the best-fit position
highest_prob_index = np.unravel_index(sampler.lnprobability.argmax(), \
                                          sampler.lnprobability.shape)
best_position = sampler.chain[highest_prob_index]

f = open(&#39;best_position_pre_burn_in_&#39; + retrieval_name + &#39;.dat&#39;, &#39;w&#39;)
f.write(str(best_position))
f.close()

# Run actual chain
p0 = [np.array([best_position[0]+np.random.normal(size=1)[0]*0.8, \
                best_position[1]+np.random.normal(size=1)[0]*0.5, \
                best_position[2]+np.random.normal(size=1)[0]*70., \
                best_position[3]+np.random.normal(size=1)[0]*200., \
                best_position[4]+np.random.normal(size=1)[0]*0.5, \
                best_position[5]+np.random.normal(size=1)[0]*0.1, \
                LOG_G, \
                -2., \
                best_position[8]+np.random.normal(size=1)[0]*0.3, \
                best_position[9]+np.random.normal(size=1)[0]*0.3, \
                best_position[10]+np.random.normal(size=1)[0]*0.3, \
                best_position[11]+np.random.normal(size=1)[0]*0.3, \
                best_position[12]+np.random.normal(size=1)[0]*0.3, \
                best_position[13]+np.random.normal(size=1)[0]*0.3, \
                best_position[14]+np.random.normal(size=1)[0]*0.3, \
                best_position[15]+np.random.normal(size=1)[0]*0.3] \
                   ) for i in range(n_walkers)]
</pre></div>
</div>
</div>
<p>And now we run the main chain:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>if cluster:
    sampler = emcee.EnsembleSampler(n_walkers, n_dim, lnprob, \
                                        a = stepsize, pool = pool)
else:
    if n_threads &gt; 1:
        sampler = emcee.EnsembleSampler(n_walkers, n_dim, lnprob, \
                                            a = stepsize, threads = n_threads)
    else:
        sampler = emcee.EnsembleSampler(n_walkers, n_dim, lnprob, \
                                            a = stepsize)

pos, prob, state = sampler.run_mcmc(p0, n_iter)

if cluster:
    pool.close()
</pre></div>
</div>
</div>
</div>
<div class="section" id="Save-the-results">
<h2>Save the results<a class="headerlink" href="#Save-the-results" title="Permalink to this headline">¶</a></h2>
<p>Finally, we save the sampled parameter positions <code class="docutils literal notranslate"><span class="pre">samples</span></code> and their associated log-probabilities to two pickle files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>f = open(&#39;chain_pos_&#39; + retrieval_name + &#39;.pickle&#39;,&#39;wb&#39;)
pickle.dump(pos,f)
pickle.dump(prob,f)
pickle.dump(state,f)
samples = sampler.chain[:, :, :].reshape((-1, n_dim))
pickle.dump(samples,f)
f.close()


with open(&#39;chain_lnprob_&#39; + retrieval_name + &#39;.pickle&#39;, &#39;wb&#39;) as f:
    pickle.dump([sampler.lnprobability], \
                f, protocol=pickle.HIGHEST_PROTOCOL)
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ret_emission_retrieval_model.html" class="btn btn-neutral float-right" title="Master retrieval model: emission case" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../ret_emission.html" class="btn btn-neutral" title="Emission spectrum retrieval" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Paul Mollière

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>